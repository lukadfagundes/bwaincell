name: Deploy to Raspberry Pi

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: deploy-pi-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Deploy to Raspberry Pi
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Raspberry Pi
    runs-on: ubuntu-latest
    environment:
      name: production

    outputs:
      previous-image: ${{ steps.backup-image.outputs.image }}
      deployment-successful: ${{ steps.deployment-result.outputs.success }}

    steps:
      - name: Backup current image tag
        id: backup-image
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USERNAME }}
          key: ${{ secrets.PI_SSH_KEY }}
          passphrase: ${{ secrets.PI_SSH_PASSPHRASE }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          timeout: 5m
          command_timeout: 2m
          script: |
            set -e

            echo "üîç Capturing current deployment state for rollback..."
            cd ~/bwaincell || exit 0

            # Get current backend image ID (if exists)
            CURRENT_IMAGE=$(docker images bwaincell-backend:latest -q 2>/dev/null || echo "none")

            if [ "$CURRENT_IMAGE" != "none" ]; then
              # Tag current image as backup
              docker tag bwaincell-backend:latest bwaincell-backend:backup 2>/dev/null || true
              echo "‚úÖ Current image backed up as bwaincell-backend:backup"
              echo "Image ID: $CURRENT_IMAGE"
            else
              echo "‚ÑπÔ∏è  No previous image to backup (first deployment)"
            fi

      - name: Deploy to Raspberry Pi
        id: deploy-main
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USERNAME }}
          key: ${{ secrets.PI_SSH_KEY }}
          passphrase: ${{ secrets.PI_SSH_PASSPHRASE }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          timeout: 60m
          command_timeout: 45m
          script: |
            set -e  # Exit on any error

            echo "================================================"
            echo "Starting Raspberry Pi Deployment - Bwaincell"
            echo "================================================"

            # Navigate to project directory
            cd ~/bwaincell || {
              echo "‚ùå Directory ~/bwaincell not found"
              exit 1
            }

            # Pull latest code from GitHub
            echo "üì• Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main

            # Clean untracked files (skip permission errors)
            git clean -fd || echo "‚ö†Ô∏è  Some files could not be cleaned (non-critical)"

            # Verify .env exists
            if [ ! -f .env ]; then
              echo "‚ùå .env not found!"
              exit 1
            fi

            echo "‚úÖ Repository updated to latest commit"
            echo "Commit: $(git log -1 --oneline)"

            # Stop existing containers
            echo "üõë Stopping existing containers..."
            docker compose down --remove-orphans || true

            # Force remove any lingering containers
            docker rm -f bwaincell-backend bwaincell-db 2>/dev/null || true

            # Clean up old images
            echo "üßπ Cleaning up old images..."
            docker rmi -f bwaincell-backend:latest || true
            docker builder prune -af

            # Build backend image
            echo "üî® Building backend image..."
            docker build --no-cache \
              -t bwaincell-backend:latest \
              -f backend/Dockerfile.INTENTIONALLY_BROKEN \
              . 2>&1 | tee build-backend.log

            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "‚ùå Backend image build failed"
              tail -100 build-backend.log
              exit 1
            fi

            echo "‚úÖ Backend image built successfully"

            # Start production service
            echo "üöÄ Starting production service..."
            docker compose up -d

            # Wait for service to start
            echo "‚è≥ Waiting for services to start..."
            sleep 20

            # Check service status
            echo "üîç Checking service status..."
            docker compose ps

            # Verify PostgreSQL is healthy
            echo "üîç Checking PostgreSQL health..."
            for i in {1..10}; do
              if docker compose exec -T postgres pg_isready -U ${POSTGRES_USER:-bwaincell} > /dev/null 2>&1; then
                echo "‚úÖ PostgreSQL is healthy"
                break
              fi
              echo "Attempt $i/10 - PostgreSQL not ready, waiting..."
              sleep 3
            done

            # Verify PostgreSQL container health status
            POSTGRES_STATUS=$(docker inspect -f '{{.State.Health.Status}}' bwaincell-db 2>/dev/null || echo "unknown")
            if [ "$POSTGRES_STATUS" != "healthy" ]; then
              echo "‚ùå PostgreSQL health check failed: $POSTGRES_STATUS"
              echo "PostgreSQL logs:"
              docker compose logs --tail=50 postgres
              exit 1
            fi
            echo "‚úÖ PostgreSQL container is healthy"

            # Verify bot health
            echo "üîç Checking bot health..."
            for i in {1..15}; do
              HEALTH=$(curl -sf http://localhost:3000/health || echo "failed")
              if echo "$HEALTH" | grep -q "healthy\|ok\|running"; then
                echo "‚úÖ Bot health check passed"
                echo "$HEALTH"
                break
              fi
              echo "Attempt $i/15 - Bot not healthy yet, waiting..."
              sleep 3
            done

            # Check bot logs for Discord connection
            echo "üîç Checking bot Discord connection..."
            sleep 5
            docker compose logs --tail=50 backend | tee backend-logs.txt

            if grep -q "Ready!\|logged in\|Bot is ready\|Connected to Discord" backend-logs.txt; then
              echo "‚úÖ Bot connected to Discord"
            else
              echo "‚ö†Ô∏è  Bot connection not confirmed - check logs"
            fi

            # Display resource usage (with timeout to avoid hanging)
            echo "üìä Container resource usage:"
            timeout 10 docker stats bwaincell-backend --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" || echo "‚ö†Ô∏è  Stats collection timed out (non-critical)"

            # Clean up old images (older than 7 days)
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -af --filter "until=168h" || true

            echo "================================================"
            echo "‚úÖ Deployment Complete"
            echo "================================================"
            echo "Backend: $(docker inspect -f '{{.State.Health.Status}}' bwaincell-backend 2>/dev/null || echo 'running')"
            echo "================================================"

      - name: Verify deployment health
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USERNAME }}
          key: ${{ secrets.PI_SSH_KEY }}
          passphrase: ${{ secrets.PI_SSH_PASSPHRASE }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          timeout: 10m
          command_timeout: 10m
          script: |
            set -e

            echo "üîç Post-Deployment Health Verification"
            echo "========================================"

            cd ~/bwaincell

            # Check Bot health with retries
            echo "Checking Bot health endpoint..."
            MAX_RETRIES=3
            RETRY_DELAY=10

            for i in $(seq 1 $MAX_RETRIES); do
              HEALTH_RESPONSE=$(curl -sf http://localhost:3000/health || echo "failed")

              if echo "$HEALTH_RESPONSE" | grep -q "healthy\|ok\|running"; then
                echo "‚úÖ Bot health check passed (attempt $i/$MAX_RETRIES)"
                echo "Response: $HEALTH_RESPONSE"
                break
              fi

              if [ $i -eq $MAX_RETRIES ]; then
                echo "‚ùå Bot health check failed after $MAX_RETRIES attempts"
                echo "Last response: $HEALTH_RESPONSE"

                echo "Bot container status:"
                docker ps -a | grep bwaincell-bot

                echo "Recent bot logs:"
                docker logs --tail=50 bwaincell-bot

                exit 1
              fi

              echo "‚è≥ Health check attempt $i/$MAX_RETRIES failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            done

            # Check Backend container is running
            echo "Checking Backend container status..."
            BACKEND_STATUS=$(docker inspect -f '{{.State.Status}}' bwaincell-backend 2>/dev/null || echo "unknown")
            if [ "$BACKEND_STATUS" != "running" ]; then
              echo "‚ùå Backend container is not running: $BACKEND_STATUS"
              docker logs --tail=100 bwaincell-backend
              exit 1
            fi
            echo "‚úÖ Backend container is running"

            # Check Discord connection in logs
            echo "Verifying Discord connection..."
            sleep 5
            if docker logs --tail=100 bwaincell-backend 2>&1 | grep -q "Ready!\|logged in\|Bot is ready\|Connected to Discord"; then
              echo "‚úÖ Bot connected to Discord"
            else
              echo "‚ö†Ô∏è  Discord connection not confirmed in logs (may still be connecting)"
              docker logs --tail=50 bwaincell-backend
            fi

            echo "========================================"
            echo "‚úÖ All health checks passed"
            echo "Deployment verified successfully"

  # ---------------------------------------------------------------------------
  # Automatic Rollback (on deployment failure)
  # ---------------------------------------------------------------------------
  rollback:
    name: Automatic Rollback
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Rollback to previous image
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USERNAME }}
          key: ${{ secrets.PI_SSH_KEY }}
          passphrase: ${{ secrets.PI_SSH_PASSPHRASE }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          timeout: 15m
          command_timeout: 10m
          script: |
            set -e

            echo "================================================"
            echo "üîÑ Starting Automatic Rollback"
            echo "================================================"

            cd ~/bwaincell || {
              echo "‚ùå Directory ~/bwaincell not found"
              exit 1
            }

            # Check if backup image exists
            BACKUP_IMAGE=$(docker images bwaincell-backend:backup -q 2>/dev/null || echo "none")

            if [ "$BACKUP_IMAGE" = "none" ]; then
              echo "‚ö†Ô∏è  No backup image available for rollback"
              echo "This may be the first deployment - manual intervention required"
              exit 1
            fi

            echo "‚úÖ Backup image found: $BACKUP_IMAGE"

            # Stop current (failed) container
            echo "üõë Stopping current container..."
            docker compose down || true

            # Restore backup image as latest
            echo "üîÑ Restoring backup image..."
            docker tag bwaincell-backend:backup bwaincell-backend:latest

            # Restart service with backup image
            echo "üöÄ Starting service with backup image..."
            docker compose up -d

            # Wait for service to start
            echo "‚è≥ Waiting for services to start..."
            sleep 20

            # Verify PostgreSQL is healthy
            echo "üîç Checking PostgreSQL health..."
            for i in {1..10}; do
              if docker compose exec -T postgres pg_isready -U ${POSTGRES_USER:-bwaincell} > /dev/null 2>&1; then
                echo "‚úÖ PostgreSQL is healthy"
                break
              fi
              echo "Attempt $i/10 - PostgreSQL not ready, waiting..."
              sleep 3
            done

            # Verify bot health
            echo "üîç Verifying bot health..."
            for i in {1..15}; do
              HEALTH=$(curl -sf http://localhost:3000/health || echo "failed")
              if echo "$HEALTH" | grep -q "healthy\|ok\|running"; then
                echo "‚úÖ Bot health check passed"
                echo "$HEALTH"
                break
              fi
              echo "Attempt $i/15 - Bot not healthy yet, waiting..."
              sleep 3
            done

            # Check bot Discord connection
            echo "üîç Checking Discord connection..."
            sleep 5
            if docker logs --tail=50 bwaincell-backend 2>&1 | grep -q "Ready!\|logged in\|Bot is ready\|Connected to Discord"; then
              echo "‚úÖ Bot connected to Discord"
            else
              echo "‚ö†Ô∏è  Discord connection not confirmed (bot may still be starting)"
            fi

            # Display final status
            echo "================================================"
            echo "‚úÖ Rollback Complete"
            echo "================================================"
            echo "Backend: $(docker inspect -f '{{.State.Health.Status}}' bwaincell-backend 2>/dev/null || echo 'running')"
            echo "================================================"

      - name: Verify rollback success
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USERNAME }}
          key: ${{ secrets.PI_SSH_KEY }}
          passphrase: ${{ secrets.PI_SSH_PASSPHRASE }}
          port: ${{ secrets.PI_SSH_PORT || 22 }}
          timeout: 5m
          command_timeout: 2m
          script: |
            set -e

            echo "üîç Verifying Rollback Success"
            echo "========================================"

            cd ~/bwaincell

            # Check container is running
            BACKEND_STATUS=$(docker inspect -f '{{.State.Status}}' bwaincell-backend 2>/dev/null || echo "unknown")

            if [ "$BACKEND_STATUS" != "running" ]; then
              echo "‚ùå Backend rollback failed: $BACKEND_STATUS"
              exit 1
            fi

            # Final health check
            HEALTH=$(curl -sf http://localhost:3000/health || echo "failed")
            if ! echo "$HEALTH" | grep -q "healthy\|ok\|running"; then
              echo "‚ùå Backend health check failed after rollback"
              exit 1
            fi

            echo "‚úÖ Backend healthy after rollback"
            echo "========================================"
