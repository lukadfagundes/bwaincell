# =============================================================================
# Bwaincell - Pre-commit Configuration (Monorepo)
# =============================================================================
# Workspace-aware hooks for backend/ and frontend/ workspaces
# Uses lint-staged for efficient workspace-scoped linting
# =============================================================================

repos:
  # ---------------------------------------------------------------------------
  # Standard Checks (All Files)
  # ---------------------------------------------------------------------------
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        exclude: ^(backend/coverage|frontend/.next|dist)/
      - id: end-of-file-fixer
        exclude: ^(backend/coverage|frontend/.next|dist)/
      - id: check-yaml
        args: ['--unsafe']  # Allow custom YAML tags in docker-compose
      - id: check-json
        exclude: ^(backend/coverage|frontend/.next)/
      - id: check-merge-conflict
      - id: check-added-large-files
        args: ['--maxkb=500']
      - id: detect-private-key

  # ---------------------------------------------------------------------------
  # Backend Linting (ESLint + Prettier via lint-staged)
  # ---------------------------------------------------------------------------
  - repo: local
    hooks:
      - id: backend-lint-staged
        name: Backend Lint (ESLint + Prettier)
        entry: bash -c 'cd backend && npx lint-staged --relative'
        language: system
        files: ^backend/.*\.(ts|js)$
        pass_filenames: false

  # ---------------------------------------------------------------------------
  # Frontend Linting (Next.js lint + Prettier via lint-staged)
  # ---------------------------------------------------------------------------
  - repo: local
    hooks:
      - id: frontend-lint-staged
        name: Frontend Lint (Next.js + Prettier)
        entry: bash -c 'cd frontend && npx prettier --write'
        language: system
        files: ^frontend/.*\.(ts|tsx|js|jsx)$
        pass_filenames: true

  # ---------------------------------------------------------------------------
  # TypeScript Type Checking (Backend)
  # ---------------------------------------------------------------------------
  - repo: local
    hooks:
      - id: backend-typecheck
        name: Backend TypeScript Type Check
        entry: bash -c 'cd backend && npm run typecheck'
        language: system
        files: ^backend/.*\.ts$
        pass_filenames: false

  # ---------------------------------------------------------------------------
  # Shared Package Build (if shared/ files changed)
  # ---------------------------------------------------------------------------
  - repo: local
    hooks:
      - id: shared-build
        name: Shared Package Build
        entry: bash -c 'npm run build:shared'
        language: system
        files: ^shared/.*\.(ts|js)$
        pass_filenames: false

  # ---------------------------------------------------------------------------
  # Prevent Accidental Commits
  # ---------------------------------------------------------------------------
  - repo: local
    hooks:
      - id: no-secrets
        name: Check for secrets in .env files
        entry: bash -c 'if git diff --cached --name-only | grep -E "\.env$" > /dev/null; then echo "❌ Attempting to commit .env file! Use .env.example instead." && exit 1; fi'
        language: system
        pass_filenames: false
        always_run: true

      - id: no-debug-logs
        name: Check for console.log in production code
        entry: bash -c 'if git diff --cached --name-only | grep -E "^(backend|frontend)/" | grep -v -E "(test|spec|__tests__|\.test\.|\.spec\.)" | xargs grep -n "console\.log" 2>/dev/null; then echo "⚠️  Found console.log in production code (remove or replace with proper logging)" && exit 1; fi'
        language: system
        pass_filenames: false
        always_run: true
