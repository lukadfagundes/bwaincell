# =============================================================================
# Bwaincell - Development Docker Compose
# =============================================================================
# Architecture: PostgreSQL only (for local development testing)
# Bot runs locally via npm run dev, connects to this PostgreSQL container
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database - Development
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: bwaincell-db-dev
    restart: unless-stopped

    # Load environment variables from .env
    env_file:
      - .env

    environment:
      POSTGRES_USER: ${POSTGRES_USER:-bwaincell}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-bwaincell}
      # Development settings (less restrictive)
      POSTGRES_SHARED_BUFFERS: 128MB
      POSTGRES_MAX_CONNECTIONS: 20

    volumes:
      # Development data storage (separate from production)
      - postgres-data-dev:/var/lib/postgresql/data
      # Database initialization script
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql

    # Expose port 5433 externally (same as production for consistency)
    ports:
      - "5433:5432"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-bwaincell}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Logging configuration with rotation
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

    labels:
      com.bwaincell.service: "postgres"
      com.bwaincell.environment: "development"

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  postgres-data-dev:
    driver: local
    labels:
      com.bwaincell.description: "PostgreSQL development database storage"

# =============================================================================
# Usage Instructions
# =============================================================================
#
# Purpose:
#   - Runs PostgreSQL container for local development
#   - Bot runs on host machine via npm run dev
#   - Connect to postgres at localhost:5433
#
# Prerequisites:
#   1. Create .env with development credentials (see .env.example)
#   2. Set DATABASE_URL=postgresql://bwaincell:password@localhost:5433/bwaincell
#
# Start PostgreSQL Only:
#   docker compose -f docker-compose.dev.yml up -d
#
# Run Bot Locally:
#   npm run dev
#
# View PostgreSQL Logs:
#   docker compose -f docker-compose.dev.yml logs -f postgres
#
# Check PostgreSQL Health:
#   docker compose -f docker-compose.dev.yml ps
#   docker compose -f docker-compose.dev.yml exec postgres pg_isready -U bwaincell
#
# Stop PostgreSQL:
#   docker compose -f docker-compose.dev.yml down
#
# Reset Development Database:
#   docker compose -f docker-compose.dev.yml down -v
#   docker compose -f docker-compose.dev.yml up -d
#
# Connect to PostgreSQL (psql):
#   docker compose -f docker-compose.dev.yml exec postgres psql -U bwaincell -d bwaincell
#
# Database Backup (Development):
#   docker compose -f docker-compose.dev.yml exec postgres pg_dump -U bwaincell bwaincell > dev-backup.sql
#
# Database Restore (Development):
#   cat dev-backup.sql | docker compose -f docker-compose.dev.yml exec -T postgres psql -U bwaincell bwaincell
#
# =============================================================================
